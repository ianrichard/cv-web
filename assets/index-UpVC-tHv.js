(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class E{constructor(e={}){this.smoothingFactor=e.smoothingFactor||.18,this.maxDistance=e.maxDistance||120,this.maxFramesWithoutDetection=e.maxFramesWithoutDetection||60,this.minUpdateThreshold=e.minUpdateThreshold||3,this.updateInterval=e.updateInterval||10,this.visualUpdateInterval=e.visualUpdateInterval||20,this.frameCounter=0,this.minConfidenceToShow=.45,this.confidenceDecayRate=.007,this.graceFrames=45,this.trackedObjects=new Map,this.nextId=0}smoothDetections(e){this.frameCounter++;const t=[],s=new Set,i=e.filter(o=>o.isFaceRecognition),n=e.filter(o=>!o.isFaceRecognition);i.forEach(o=>{t.push({...o,id:"face-"+this.frameCounter})});const c=this.frameCounter%this.updateInterval===0,r=this.frameCounter%this.visualUpdateInterval===0,d=Array.from(this.trackedObjects.entries()).filter(([,o])=>!o.isFaceRecognition).sort(([,o],[,a])=>{const l=(a.stabilityFrames||0)-(o.stabilityFrames||0);return Math.abs(l)>30?l:(a.confidence||0)-(o.confidence||0)});for(const[o,a]of d){let l=null,p=1/0,b=-1;if(n.forEach((m,u)=>{if(!s.has(u)&&this.classesMatch(m.class,a.class)){const f=this.calculateDistance(a.smoothedBbox||a.displayedBbox,m.bbox);f<this.maxDistance&&f<p&&(l=m,p=f,b=u)}}),l){const m=p<20&&(a.stabilityFrames||0)>60;if(c||!m||(a.framesSinceDetection||0)>10){const u=this.applySmoothingToBbox(a.smoothedBbox||a.displayedBbox,l.bbox);r||!m||(a.framesSinceLastVisualUpdate||0)>45?(a.displayedBbox=[...u],a.framesSinceLastVisualUpdate=0):a.framesSinceLastVisualUpdate=(a.framesSinceLastVisualUpdate||0)+1,p>this.minUpdateThreshold||(a.framesSinceLastUpdate||0)>45?(a.smoothedBbox=u,a.framesSinceLastUpdate=0):a.framesSinceLastUpdate=(a.framesSinceLastUpdate||0)+1}else a.framesSinceLastUpdate=(a.framesSinceLastUpdate||0)+1,a.framesSinceLastVisualUpdate=(a.framesSinceLastVisualUpdate||0)+1;a.score=this.smoothValue(a.score,l.score,.05),a.framesSinceDetection=0,a.confidence=Math.min((a.confidence||0)+.1,1),a.stabilityFrames=Math.min((a.stabilityFrames||0)+1,180),a.class=l.class,t.push({...l,bbox:a.displayedBbox||a.smoothedBbox,score:a.score,class:a.class,id:o}),s.add(b)}else if(a.framesSinceDetection=(a.framesSinceDetection||0)+1,a.framesSinceLastVisualUpdate=(a.framesSinceLastVisualUpdate||0)+1,a.framesSinceDetection>this.graceFrames&&(a.confidence=Math.max((a.confidence||0)-this.confidenceDecayRate,this.minConfidenceToShow)),a.stabilityFrames=Math.max((a.stabilityFrames||0)-.2,0),a.framesSinceDetection<this.maxFramesWithoutDetection){const m=a.score*Math.max(.6,1-a.framesSinceDetection*.003);t.push({class:a.class,bbox:a.displayedBbox||a.smoothedBbox,score:m,id:o,isTracked:!0,isFading:a.framesSinceDetection>90})}}return n.forEach((o,a)=>{if(!s.has(a)){const l=this.nextId++;this.trackedObjects.set(l,{id:l,class:o.class,smoothedBbox:[...o.bbox],displayedBbox:[...o.bbox],score:o.score,framesSinceDetection:0,framesSinceLastUpdate:0,framesSinceLastVisualUpdate:0,confidence:.9,stabilityFrames:0,createdAt:Date.now()}),t.push({...o,id:l,isNew:!0})}}),this.frameCounter%300===0&&this.cleanupOldObjects(),t}applySmoothingToBbox(e,t,s=null){const i=s||this.smoothingFactor;return[this.smoothCoordinate(e[0],t[0],i),this.smoothCoordinate(e[1],t[1],i),this.smoothCoordinate(e[2],t[2],i),this.smoothCoordinate(e[3],t[3],i)]}smoothCoordinate(e,t,s){const n=Math.abs(t-e)>50?Math.min(s*2,.3):s;return e*(1-n)+t*n}smoothValue(e,t,s){return e*(1-s)+t*s}calculateDistance(e,t){const s=e[0]+e[2]/2,i=e[1]+e[3]/2,n=t[0]+t[2]/2,c=t[1]+t[3]/2;return Math.sqrt((s-n)**2+(i-c)**2)}classesMatch(e,t){var c,r;if(e===t)return!0;const s={person:["face","human"],face:["person","human"],"Reference Match":["Reference Match"],car:["vehicle"],bicycle:["bike"],motorcycle:["motorbike"]},i=e.toLowerCase(),n=t.toLowerCase();return((c=s[i])==null?void 0:c.includes(n))||((r=s[n])==null?void 0:r.includes(i))||!1}cleanupOldObjects(){const e=Date.now();for(const[t,s]of this.trackedObjects){const i=s.isFaceRecognition?50:this.maxFramesWithoutDetection,n=s.isFaceRecognition?3e3:1e4;(s.framesSinceDetection>=i||s.confidence&&s.confidence<.05||e-s.createdAt>n)&&this.trackedObjects.delete(t)}}reset(){this.trackedObjects.clear(),this.nextId=0}getTrackingStats(){return{trackedCount:this.trackedObjects.size,nextId:this.nextId}}}class I{constructor(){this.model=null,this.modelType=null,this.canvas=document.getElementById("output"),this.ctx=this.canvas.getContext("2d"),this.isDetecting=!1,this.animationFrame=null,this.devicePixelRatio=window.devicePixelRatio||1,this.canvasWidth=0,this.canvasHeight=0,this.frameCount=0,this.lastTime=performance.now(),this.fps=0,this.targetFPS=this.detectPlatform(),this.frameInterval=1e3/this.targetFPS,this.lastFrameTime=0,this.trackedObjects=new Map,this.nextObjectId=0,this.smoothingFactor=.8,this.confidenceThreshold=.6,this.maxTrackingDistance=100,this.maxFramesWithoutDetection=8,this.referenceImageData=null,this.faceRecognitionEnabled=!1,this.performanceVisible=!1,this.objectCount=0,this.smoother=new E({smoothingFactor:.05,maxDistance:150,maxFramesWithoutDetection:30,minUpdateThreshold:3,updateInterval:30}),this.faceRenderCounter=0,this.setupResizeObserver()}setupResizeObserver(){typeof ResizeObserver<"u"?(this.resizeObserver=new ResizeObserver(()=>{this.updateCanvasSize()}),this.resizeObserver.observe(this.canvas.parentElement)):window.addEventListener("resize",()=>this.updateCanvasSize())}updateCanvasSize(){const t=this.canvas.parentElement.getBoundingClientRect();this.canvasWidth=t.width,this.canvasHeight=t.height;const s=Math.floor(this.canvasWidth*this.devicePixelRatio),i=Math.floor(this.canvasHeight*this.devicePixelRatio);(this.canvas.width!==s||this.canvas.height!==i)&&(this.canvas.width=s,this.canvas.height=i,this.canvas.style.width=this.canvasWidth+"px",this.canvas.style.height=this.canvasHeight+"px",this.ctx.scale(this.devicePixelRatio,this.devicePixelRatio),this.ctx.textBaseline="top",this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high")}detectPlatform(){const e=navigator.userAgent.toLowerCase(),t=navigator.deviceMemory||4;return e.includes("raspberry")||t<=4?15:e.includes("mac")?30:25}setModel(e,t="unknown"){this.model=e,this.modelType=t,console.log(`Model set: ${t}`);const s=document.getElementById("currentModel");s&&(s.textContent=t)}async startDetection(e){this.isDetecting=!0,this.updateCanvasSize(),this.videoElement=e,this.detectLoop()}stopDetection(){this.isDetecting=!1,this.animationFrame&&cancelAnimationFrame(this.animationFrame)}async detectLoop(){if(!this.isDetecting||!this.model)return;const e=performance.now();if(e-this.lastFrameTime<this.frameInterval){this.animationFrame=requestAnimationFrame(()=>this.detectLoop());return}this.lastFrameTime=e;try{this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight);const t=this.getFlippedFrame(this.videoElement),s=performance.now(),i=await this.model.detect(t),n=performance.now()-s,c=i.filter(d=>d.score>=this.confidenceThreshold),r=this.smoother.smoothDetections(c);this.objectCount=r.length,this.drawPredictions(r,this.videoElement),this.updatePerformanceStats(e,n)}catch(t){console.error("Detection error:",t)}this.animationFrame=requestAnimationFrame(()=>this.detectLoop())}getFlippedFrame(e){const t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight;const s=t.getContext("2d");return s.save(),s.translate(t.width,0),s.scale(-1,1),s.drawImage(e,0,0,t.width,t.height),s.restore(),t}setFaceRecognitionManager(e){this.faceRecognitionManager=e}async loadReferenceImage(e="images/face.jpg"){try{const t=new Image;return t.crossOrigin="anonymous",await new Promise((s,i)=>{t.onload=s,t.onerror=i,t.src=e}),this.referenceImageData=t,this.faceRecognitionEnabled=!0,console.log("Reference image loaded successfully"),!0}catch{return console.log("Reference image not found, face recognition disabled"),!1}}updatePerformanceStats(e,t){this.frameCount++,e-this.lastTime>=1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastTime=e,this.updatePerformanceUI(t),console.log(`FPS ${this.fps}, Inference: ${t.toFixed(1)}ms, Objects: ${this.objectCount}`))}updatePerformanceUI(e){const t=document.getElementById("fpsCounter"),s=document.getElementById("inferenceTime"),i=document.getElementById("objectCount");t&&(t.textContent=this.fps),s&&(s.textContent=e.toFixed(1)),i&&(i.textContent=this.objectCount)}togglePerformance(){this.performanceVisible=!this.performanceVisible;const e=document.getElementById("performanceStats");e&&(e.style.display=this.performanceVisible?"block":"none")}drawPredictions(e,t){const s=this.canvasWidth,i=this.canvasHeight,n=t.videoWidth/t.videoHeight,c=s/i;let r,d,o=0,a=0;n>c?(d=i/t.videoHeight,r=d,o=(s-t.videoWidth*r)/2):(r=s/t.videoWidth,d=r,a=(i-t.videoHeight*d)/2),e.forEach(l=>{const[p,b,m,u]=l.bbox,f=p*r+o,x=b*d+a,w=m*r,S=u*d;let h="#00FF00";if(l.isFaceRecognition)h="#FF0000";else switch(l.class){case"person":h="#FF6B6B";break;case"car":h="#4ECDC4";break;case"truck":h="#96CEB4";break;case"bus":h="#FFEAA7";break;case"bicycle":h="#45B7D1";break;case"motorcycle":h="#A29BFE";break;case"dog":h="#FD79A8";break;case"cat":h="#FDCB6E";break;case"bird":h="#6C5CE7";break;default:h="#00FF00"}this.ctx.strokeStyle=h,this.ctx.lineWidth=l.isFaceRecognition?3:2,this.ctx.setLineDash([]),this.ctx.strokeRect(f,x,w,S);let y;l.isFaceRecognition?y=`${l.class} ${(l.similarity*100).toFixed(0)}%`:y=`${l.class}: ${(l.score*100).toFixed(0)}%`;const v=14;this.ctx.font=`bold ${v}px Arial`,this.ctx.textAlign="left",this.ctx.textBaseline="top";const C=this.ctx.measureText(y).width,F=v*1.2;this.ctx.fillStyle=h,this.ctx.fillRect(f,x-F-8,C+12,F+4),this.ctx.fillStyle="#000000",this.ctx.fillText(y,f+6,x-F-4)})}adjustSmoothingSettings(e){this.smoother=new E({...this.smoother,...e})}resetSmoothing(){this.smoother.reset()}}class T{constructor(){this.model=null,this.modelLoaded=!1,this.enabledTags=new Set,this.allTags=["person","cell phone","bottle","cup","fork","spoon","bowl","banana","apple","sandwich","orange","broccoli","carrot","hot dog","pizza","donut","cake","chair","couch","potted plant","bed","dining table","tv","laptop","mouse","remote","keyboard","book","clock","scissors","teddy bear","toothbrush"],this.enabledTags=new Set(["person","cell phone"])}async loadModel(){if(this.modelLoaded)return this.model;if(typeof cocoSsd>"u")throw new Error("COCO-SSD library not loaded");return console.log("Loading COCO-SSD model..."),this.model=await cocoSsd.load(),this.modelLoaded=!0,console.log("COCO-SSD model loaded successfully"),this.model}async detect(e){if(!this.modelLoaded||!this.model)throw new Error("Model not loaded");return(await this.model.detect(e)).filter(s=>this.enabledTags.has(s.class))}getAllTags(){return this.allTags}getEnabledTags(){return Array.from(this.enabledTags)}setEnabledTags(e){this.enabledTags=new Set(e)}enableTag(e){this.enabledTags.add(e)}disableTag(e){this.enabledTags.delete(e)}isTagEnabled(e){return this.enabledTags.has(e)}enableAllTags(){this.enabledTags=new Set(this.allTags)}disableAllTags(){this.enabledTags.clear()}getActiveFilterCount(){return this.enabledTags.size}isModelLoaded(){return this.modelLoaded}}class M{constructor(){this.isLoaded=!1,this.isRunning=!1,this.animationFrame=null,this.canvas=null,this.ctx=null,this.videoElement=null,this.referenceDescriptor=null,this.similarityThreshold=.8,this.currentFace=null,this.frameCount=0,this.fps=0,this.lastTime=performance.now(),this.frameCounter=0}async loadModel(){try{console.log("Loading face-api.js models...");const e="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@latest/model";return await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(e),faceapi.nets.faceLandmark68Net.loadFromUri(e),faceapi.nets.faceRecognitionNet.loadFromUri(e)]),this.isLoaded=!0,console.log("Face-api.js models loaded successfully"),!0}catch(e){return console.error("Failed to load face-api.js models:",e),!1}}setCanvas(e){this.canvas=e,this.ctx=e.getContext("2d")}async loadReferenceImage(e="/images/face.jpg"){try{let t;if(typeof e=="string"?(t=new Image,t.crossOrigin="anonymous",await new Promise((s,i)=>{t.onload=s,t.onerror=i,t.src=e})):t=e,this.isLoaded){console.log("Attempting to extract face descriptor from new reference image...");const s=await faceapi.detectSingleFace(t,new faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptor();s?(this.referenceDescriptor=s.descriptor,console.log("SUCCESS: New reference face descriptor extracted and set.")):console.error("FAILED: No face found in the new reference image. The previous reference will be kept.")}return!0}catch(t){return console.error("Failed to process reference image:",t),!1}}async startDetection(e){if(!this.isLoaded||!this.canvas){console.error("Face detector not ready");return}this.videoElement=e,this.isRunning=!0,this.detectLoop()}stopDetection(){this.isRunning=!1,this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}async detectLoop(){if(this.isRunning){try{if(this.frameCount++,this.frameCount%10===0){const i=this.getFlippedFrame(this.videoElement),n=await faceapi.detectSingleFace(i,new faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptor();if(n&&this.referenceDescriptor){const c=faceapi.euclideanDistance(this.referenceDescriptor,n.descriptor);if(c<=this.similarityThreshold){const d=n.detection.box,o=[d.x,d.y,d.width,d.height];this.updateFace({bbox:o},c)}else this.currentFace=null}else this.currentFace=null}const s=this.canvas.parentElement.getBoundingClientRect();this.ctx.clearRect(0,0,s.width,s.height),this.currentFace&&this.drawFace(),this.updatePerformance()}catch(e){console.error("Face detection error:",e)}this.animationFrame=requestAnimationFrame(()=>this.detectLoop())}}getFlippedFrame(e){const t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight;const s=t.getContext("2d");return s.save(),s.translate(t.width,0),s.scale(-1,1),s.drawImage(e,0,0,t.width,t.height),s.restore(),t}updateFace(e,t){const s=e.bbox,i=Math.max(0,1-t/this.similarityThreshold);this.currentFace?(this.currentFace.bbox=[Math.round(this.currentFace.bbox[0]*.8+s[0]*.2),Math.round(this.currentFace.bbox[1]*.8+s[1]*.2),Math.round(this.currentFace.bbox[2]*.9+s[2]*.1),Math.round(this.currentFace.bbox[3]*.9+s[3]*.1)],this.currentFace.similarity=this.currentFace.similarity*.8+i*.2):this.currentFace={bbox:s,similarity:i}}drawFace(){if(!this.currentFace||!this.ctx)return;const t=this.canvas.parentElement.getBoundingClientRect(),s=t.width,i=t.height,n=this.videoElement.videoWidth/this.videoElement.videoHeight,c=s/i;let r,d,o=0,a=0;n>c?(d=i/this.videoElement.videoHeight,r=d,o=(s-this.videoElement.videoWidth*r)/2):(r=s/this.videoElement.videoWidth,d=r,a=(i-this.videoElement.videoHeight*d)/2);const[l,p,b,m]=this.currentFace.bbox,u=l*r+o,f=p*d+a,x=b*r,w=m*d,h=Math.min(100,this.currentFace.similarity*100)>=25,y=h?"#00FF00":"#FF0000",v=this.referenceDescriptorName||"Unknown",D=h?`Face, probably ${v}`:`Face, probably not ${v}`;this.ctx.strokeStyle=y,this.ctx.lineWidth=3,this.ctx.strokeRect(u,f,x,w),this.ctx.font="bold 14px Arial",this.ctx.textAlign="left",this.ctx.textBaseline="top";const F=this.ctx.measureText(D).width,L=14*1.2;this.ctx.fillStyle=y,this.ctx.fillRect(u,f-L-8,F+12,L+4),this.ctx.fillStyle="#000000",this.ctx.fillText(D,u+6,f-L-4)}updatePerformance(){this.frameCounter++;const e=performance.now();if(e-this.lastTime>=1e3){this.fps=this.frameCounter,this.frameCounter=0,this.lastTime=e;const t=document.getElementById("fpsCounter"),s=document.getElementById("objectCount");t&&(t.textContent=this.fps),s&&(s.textContent=this.currentFace?1:0)}}updateSettings(e){e.similarityThreshold!==void 0&&(this.similarityThreshold=e.similarityThreshold)}}class B{constructor(){this.statusElement=document.getElementById("statusText")}updateStatus(e){this.statusElement&&(this.statusElement.textContent=e),console.log("Status:",e)}setupTagFilters(e){const t=document.getElementById("tagGrid");document.getElementById("activeFilters"),t&&(t.innerHTML="",e.getAllTags().forEach(s=>{const i=document.createElement("div");i.className="tag-item";const n=document.createElement("input");n.type="checkbox",n.id=`tag-${s}`,n.checked=e.isTagEnabled(s);const c=document.createElement("label");c.htmlFor=`tag-${s}`,c.textContent=s,n.addEventListener("change",()=>{n.checked?e.enableTag(s):e.disableTag(s),this.updateActiveFiltersCount(e)}),i.appendChild(n),i.appendChild(c),t.appendChild(i)}),this.updateActiveFiltersCount(e))}updateTagFilters(e){e.getAllTags().forEach(t=>{const s=document.getElementById(`tag-${t}`);s&&(s.checked=e.isTagEnabled(t))}),this.updateActiveFiltersCount(e)}updateActiveFiltersCount(e){const t=document.getElementById("activeFilters");if(t){const s=e.getActiveFilterCount(),i=e.getAllTags().length;s===i?t.textContent=`All (${i})`:s===0?t.textContent="None":t.textContent=`${s}/${i}`}}}class R{constructor(){this.detector=new I,this.modelManager=new T,this.faceDetector=new M,this.ui=new B,this.video=null,this.isDetectionRunning=!1,this.currentMode="objects",window.detector=this.detector,window.modelManager=this.modelManager,window.faceDetector=this.faceDetector,this.modelLoadingIndicator=document.getElementById("modelLoadingIndicator")}async init(){try{this.ui.updateStatus("Initializing TensorFlow.js…"),await tf.ready(),console.log("TensorFlow.js backend:",tf.getBackend()),this.ui.updateStatus("Setting up camera…"),this.video=await this.setupCamera(),this.showModelLoadingIndicator("Downloading models…"),this.ui.updateStatus("Loading models…"),await Promise.all([this.loadObjectDetectionModel(),this.loadFaceDetectionModel()]),this.hideModelLoadingIndicator(),this.ui.updateStatus("Model ready"),this.setupEventListeners(),this.setupDemoTabs()}catch(e){this.hideModelLoadingIndicator(),console.error("Initialization failed:",e),this.ui.updateStatus(`Initialization failed: ${e.message}`)}}async setupCamera(){const e=document.getElementById("webcam");e.style.transform="scaleX(-1)";const t=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720}});return e.srcObject=t,new Promise(s=>{e.onloadedmetadata=()=>s(e)})}showModelLoadingIndicator(e="Downloading models…",t=null){this.modelLoadingIndicator&&(this.modelLoadingIndicator.style.display="flex",this.modelLoadingIndicator.querySelector(".model-loading-message").textContent=e,t!==null?this.modelLoadingIndicator.querySelector(".model-loading-progress").textContent=`${t}%`:this.modelLoadingIndicator.querySelector(".model-loading-progress").textContent="")}hideModelLoadingIndicator(){this.modelLoadingIndicator&&(this.modelLoadingIndicator.style.display="none");const e=document.querySelector(".metrics-section"),t=document.querySelector(".demo-section");e&&(e.style.display=""),t&&(t.style.display="")}async loadObjectDetectionModel(){try{this.showModelLoadingIndicator("Downloading object detection model…"),await this.modelManager.loadModel(),this.hideModelLoadingIndicator(),this.ui.setupTagFilters(this.modelManager);const e=document.querySelector(".filter-actions");e&&(e.style.display="flex");const t={detect:s=>this.modelManager.detect(s)};this.detector.setModel(t,"COCO-SSD")}catch(e){this.hideModelLoadingIndicator(),console.error("Object detection model loading failed:",e)}}async loadFaceDetectionModel(){try{this.showModelLoadingIndicator("Downloading face detection model…"),await this.faceDetector.loadModel(),await this.faceDetector.loadReferenceImage("/cv-web/images/default.jpg"),this.faceDetector.setCanvas(document.getElementById("output")),this.faceDetector.referenceDescriptorName="default.jpg",this.hideModelLoadingIndicator()}catch(e){this.hideModelLoadingIndicator(),console.error("Face detection model loading failed:",e)}}getFlippedFrame(e){const t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight;const s=t.getContext("2d");return s.save(),s.translate(t.width,0),s.scale(-1,1),s.drawImage(e,0,0,t.width,t.height),s.restore(),t}setupDemoTabs(){const e=document.querySelectorAll(".demo-tab"),t=document.querySelectorAll(".demo-content");e.forEach(s=>{s.addEventListener("click",i=>{i.stopPropagation();const n=s.dataset.tab;this.switchDemoMode(n),e.forEach(c=>c.classList.remove("active")),t.forEach(c=>c.style.display="none"),s.classList.add("active"),document.getElementById(`${n}-content`).style.display="block"})}),this.setupFaceControls()}setupFaceControls(){const e=document.getElementById("uploadReferenceBtn"),t=document.getElementById("referenceUpload"),s=document.getElementById("resetReferenceBtn");e.addEventListener("click",()=>t.click()),t.addEventListener("change",async i=>{const n=i.target.files[0];if(n&&n.type.startsWith("image/")){const c=new FileReader,r=n.name;c.onload=async d=>{const o=new Image;o.onload=async()=>{console.log(`Uploading image: ${r}`),await this.faceDetector.loadReferenceImage(o),this.faceDetector.referenceDescriptorName=r,document.getElementById("referencePreview").src=d.target.result,document.getElementById("referencePreview").style.display="block",document.querySelector(".no-image").style.display="none",console.log("Reference image and name updated")},o.src=d.target.result},c.readAsDataURL(n)}}),s.addEventListener("click",async()=>{console.log("Resetting to default reference image..."),await this.faceDetector.loadReferenceImage(),this.faceDetector.referenceDescriptorName="default.jpg",document.getElementById("referencePreview").src="/images/face.jpg",document.getElementById("referencePreview").style.display="block",document.querySelector(".no-image").style.display="none",console.log("Reference image reset to default")})}switchDemoMode(e){const t=this.isDetectionRunning;if(t&&this.stopDetection(),this.currentMode=e,e==="objects"){const s={detect:i=>this.modelManager.detect(i)};this.detector.setModel(s,"COCO-SSD")}t&&setTimeout(()=>this.startDetection(),100)}setupEventListeners(){const e=document.getElementById("toggleDetectionBtn");e.addEventListener("click",()=>{if(this.isDetectionRunning)this.stopDetection();else{const t=document.getElementById("bottomPanel"),s=document.querySelector(".main-container");t&&s&&(t.classList.remove("expanded"),t.classList.add("collapsed"),s.classList.remove("panel-open")),this.startDetection()}}),document.getElementById("selectAllBtn").addEventListener("click",()=>{this.modelManager.enableAllTags(),this.ui.updateTagFilters(this.modelManager)}),document.getElementById("selectNoneBtn").addEventListener("click",()=>{this.modelManager.disableAllTags(),this.ui.updateTagFilters(this.modelManager)}),this.detector.model&&(e.disabled=!1,e.textContent="Start")}startDetection(){this.isDetectionRunning=!0;const e=document.getElementById("toggleDetectionBtn");e.textContent="Stop",e.classList.add("running"),this.currentMode==="face"?this.faceDetector.startDetection(this.video):this.detector.startDetection(this.video),this.ui.updateStatus(`${this.currentMode==="objects"?"Detecting objects…":"Detecting face…"}`)}stopDetection(){this.isDetectionRunning=!1;const e=document.getElementById("toggleDetectionBtn");e.textContent="Start",e.classList.remove("running"),this.detector.stopDetection(),this.faceDetector.stopDetection(),this.ui.updateStatus("Detection stopped")}}document.addEventListener("DOMContentLoaded",function(){const g=document.getElementById("fabToggle"),e=document.getElementById("bottomPanel"),t=document.querySelector(".main-container");g.addEventListener("click",function(s){s.stopPropagation(),e.classList.contains("expanded")?(e.classList.remove("expanded"),e.classList.add("collapsed"),t.classList.remove("panel-open")):(e.classList.remove("collapsed"),e.classList.add("expanded"),t.classList.add("panel-open"))}),document.addEventListener("click",function(s){e.classList.contains("expanded")&&!s.target.closest("#bottomPanel")&&s.target!==g&&(e.classList.remove("expanded"),e.classList.add("collapsed"),t.classList.remove("panel-open"))})});document.addEventListener("DOMContentLoaded",()=>{new R().init()});
